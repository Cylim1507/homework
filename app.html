<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RFID Access Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.css" rel="stylesheet">
    <style>
        .card { margin-bottom: 20px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .stat-card { text-align: center; padding: 15px; }
        .stat-value { font-size: 2rem; font-weight: bold; }
        .stat-label { color: #6c757d; }
        .log-entry { padding: 10px; border-bottom: 1px solid #eee; }
        .log-entry:last-child { border-bottom: none; }
        .status-unlocked { color: #28a745; }
        .status-locked { color: #dc3545; }
    </style>
</head>
<body>
    <div class="container-fluid py-4">
        <h1 class="text-center mb-4">RFID Access Control Dashboard</h1>
        
        <div class="row">
            <!-- Statistics Cards -->
            <div class="col-md-3">
                <div class="card stat-card bg-light">
                    <div class="stat-value" id="total-entries">0</div>
                    <div class="stat-label">Total Entries</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card bg-light">
                    <div class="stat-value" id="unlock-count">0</div>
                    <div class="stat-label">Unlock Events</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card bg-light">
                    <div class="stat-value" id="avg-duration">0</div>
                    <div class="stat-label">Avg Unlock (sec)</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card bg-light">
                    <div class="stat-value" id="last-update">Now</div>
                    <div class="stat-label">Last Update</div>
                </div>
            </div>
        </div>
        
        <div class="row mt-4">
            <!-- Access Log Chart -->
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h5>Access Activity</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="accessChart" height="200"></canvas>
                    </div>
                </div>
            </div>
            
            <!-- Recent Logs -->
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5>Recent Access Logs</h5>
                    </div>
                    <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                        <div id="recent-logs"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row mt-4">
            <!-- Rules Configuration -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>System Rules</h5>
                    </div>
                    <div class="card-body">
                        <form id="rules-form">
                            <div class="mb-3">
                                <label for="alarm-delay" class="form-label">Alarm Delay (seconds)</label>
                                <input type="number" class="form-control" id="alarm-delay" min="1" max="60">
                            </div>
                            <div class="mb-3">
                                <label for="force-threshold" class="form-label">Force Sensor Threshold</label>
                                <input type="number" class="form-control" id="force-threshold" min="0" max="1023">
                            </div>
                            <button type="submit" class="btn btn-primary">Update Rules</button>
                        </form>
                    </div>
                </div>
            </div>
            
            <!-- Device Control -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>Device Control</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <button class="btn btn-success" onclick="triggerAction('unlock')">Unlock Device</button>
                            <button class="btn btn-danger" onclick="triggerAction('lock')">Lock Device</button>
                            <button class="btn btn-warning" onclick="triggerAction('alarm')">Test Alarm</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
    <script>
        let accessChart;
        
        // Load data and initialize dashboard
        async function loadData() {
            const response = await fetch('/api/logs');
            const data = await response.json();
            
            // Update statistics
            document.getElementById('total-entries').textContent = data.stats.total_entries;
            document.getElementById('unlock-count').textContent = data.stats.unlock_count;
            document.getElementById('avg-duration').textContent = data.duration_stats.avg_unlock_time?.toFixed(1) || 'N/A';
            document.getElementById('last-update').textContent = 'Now';
            
            // Update recent logs
            const logsContainer = document.getElementById('recent-logs');
            logsContainer.innerHTML = data.logs.map(log => `
                <div class="log-entry">
                    <strong>${log.timestamp}</strong><br>
                    <span class="status-${log.status.toLowerCase()}">${log.status}</span> - ${log.uid}
                </div>
            `).join('');
            
            // Update chart
            updateChart(data.logs.reverse());
            
            // Load current rules
            const rulesResponse = await fetch('/api/rules');
            const rules = await rulesResponse.json();
            document.getElementById('alarm-delay').value = rules.alarm_delay || 15;
            document.getElementById('force-threshold').value = rules.force_threshold || 100;
        }
        
        function updateChart(logs) {
            const ctx = document.getElementById('accessChart').getContext('2d');
            
            // Prepare data for chart
            const labels = logs.map(log => log.timestamp.split(' ')[1].substring(0, 5));
            const data = logs.map(log => log.status === 'UNLOCKED' ? 1 : 0);
            
            if (accessChart) {
                accessChart.data.labels = labels;
                accessChart.data.datasets[0].data = data;
                accessChart.update();
            } else {
                accessChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Access Status',
                            data: data,
                            borderColor: 'rgba(75, 192, 192, 1)',
                            backgroundColor: 'rgba(75, 192, 192, 0.2)',
                            borderWidth: 2,
                            tension: 0.1,
                            pointRadius: 5,
                            pointHoverRadius: 7
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                min: 0,
                                max: 1,
                                ticks: {
                                    callback: function(value) {
                                        return value === 1 ? 'UNLOCKED' : 'LOCKED';
                                    }
                                }
                            }
                        }
                    }
                });
            }
        }
        
        // Handle rules form submission
        document.getElementById('rules-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const rules = {
                alarm_delay: parseInt(document.getElementById('alarm-delay').value),
                force_threshold: parseInt(document.getElementById('force-threshold').value)
            };
            
            await fetch('/api/rules', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(rules)
            });
            
            alert('Rules updated successfully!');
        });
        
        // Trigger device actions
        async function triggerAction(action) {
            await fetch('/api/trigger', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ action })
            });
            
            alert(`Action "${action}" triggered!`);
        }
        
        // Initial load
        loadData();
        
        // Refresh data every 10 seconds
        setInterval(loadData, 10000);
    </script>
</body>
</html>
